---
layout: post
title: "systemtap notes"
description: "systemtap是redhat开发的一个分析工具，功能非常强大，这里记录一点自己在使用上碰到的一些问题"
categories: [tech]
tags: [ubuntu, performance, tools]
---

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Systemtap</a>
<ul>
<li><a href="#sec-1-1">1.1 使用前提</a></li>
<li><a href="#sec-1-2">1.2 编译</a>
<ul>
<li><a href="#sec-1-2-1">1.2.1 configure</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">Systemtap</h2>
<div class="outline-text-2" id="text-1">

<p>systemtap是红帽开发的一款分析工具，如果你需要使用的话，最好在redhat的系统上，其
他系统兼容性都不好，基本上都只能使用部分功能（主要是kernel那部分），他自带的很多
例子都无法兼容（主要还是代码对不上）。
</p>
<p>
我电脑使用的是ubuntu 12.04，kernel用的是trusy版本的3.13，自带的版本是1.6，基本没
法用。
</p>

</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1">使用前提</h3>
<div class="outline-text-3" id="text-1-1">

<p>需要安装dbgsym包，这个包在ubuntu的ddeb源提供<sup><a class="footref" name="fnr-.1" href="#fn-.1">1</a></sup>，系统缺省不包括，需要自己添加：
</p>


<pre class="example">tacy@tacy:~$echo "deb http://ddebs.ubuntu.com $(lsb_release -cs) main restricted universe multiverse
deb http://ddebs.ubuntu.com $(lsb_release -cs)-updates main restricted universe multiverse
deb http://ddebs.ubuntu.com $(lsb_release -cs)-security main restricted universe multiverse
deb http://ddebs.ubuntu.com $(lsb_release -cs)-proposed main restricted universe multiverse" | \
sudo tee -a /etc/apt/sources.list.d/ddebs.list

tacy@tacy:~$sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 428D7C01

tacy@tacy:~$apt-get update
</pre>


<p>
然后你就能看到很多dbgsym包，先安装对应kernel的
</p>


<pre class="example">tacy@tacy:~$ uname -a
Linux tacy 3.13.0-27-generic #50~precise1-Ubuntu SMP Fri May 16 20:47:56 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux
tacy@tacy:~$ apt-cache policy linux-image-3.13.0-27-generic
linux-image-3.13.0-27-generic:
  已安装：  3.13.0-27.50~precise1
  候选软件包：3.13.0-27.50~precise1
  版本列表：
 *** 3.13.0-27.50~precise1 0
        500 http://mirrors.ustc.edu.cn/ubuntu/ precise-updates/main amd64 Packages
        500 http://mirrors.ustc.edu.cn/ubuntu/ precise-security/main amd64 Packages
        100 /var/lib/dpkg/status
tacy@tacy:~$ sudo apt-get install linux-image-3.13.0-27-generic-dbgsym=3.13.0-27.50~precise1
</pre>


</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2">编译</h3>
<div class="outline-text-3" id="text-1-2">

<p>没啥特殊的，注意elfutils版本就行，缺省的0.152好像没问题。我编译了systemtap 2.5版
本，可以用。
</p>
<p>
另外需要主要的即使systemtap可以配合byteman使用，但是～，基本上别抱啥希望，我尝试
了一下，问题一堆，能正常编译，无法使用，当然你也可以试试，一些需要注意的点：
</p>

</div>

<div id="outline-container-1-2-1" class="outline-4">
<h4 id="sec-1-2-1">configure</h4>
<div class="outline-text-4" id="text-1-2-1">

<p>仔细看systemtap源代码中java目录下的readme，这里有好几个坑：
</p>
<p>
首先是编译的时候要指定&ndash;with-java选项，否则不支持。
</p>
<p>
另一个是BYTEMAN_HOME，你从jboss网站上下载下来的byteman解压之后，jar包在lib目录下，
但是stapbm脚本直接忽略了lib目录，也就是说你找不到jar包，没有任何提示，无法成功。
</p>
<p>
其次是libHelperSDT_amd64.so和HelperSDT.jar两个文件，主要必须是做链接，不能拷贝
，否则也是白搭，你可以看一下生成出来的C文件（在~/.systemtap/cache目录下），里面
有如下内容：
</p><pre class="example">
process(\"/usr/local/libexec/systemtap/libHelperSDT_amd64.so\").
</pre>

<p>人家明确写的是systemtap下的so文件，如果你拷贝到jdk目录下，直接无视，泪啊～～～，
为啥在README里面要写copy/link呢？
</p>
<p>
最后一个，必须是同一个用户的进程才行，也就是说如果你用root去分析其他用户的java进
程，不好意思，同样无视～～～
</p>
<p>
解决上面问题之后，简单的例子能跑了<sup><a class="footref" name="fnr-.2" href="#fn-.2">2</a></sup>，但是我尝试了一下对weblogic做profile，
不行，一直抛如下错误，放弃～
</p>



<pre class="example">org.jboss.byteman.rule.exception.ExecuteException: stap_672db8a0071794f3697f800e2d70a51_22140probe_2237  : caught java.lang.ClassCircularityError: sun/reflect/MethodAccessorImpl
        at org.jboss.byteman.rule.Rule.execute(Rule.java:716)
        at org.jboss.byteman.rule.Rule.execute(Rule.java:653)
        at java.lang.ClassLoader.loadClass(ClassLoader.java)
        at sun.misc.Unsafe.defineClass(Native Method)
        at sun.reflect.ClassDefiner.defineClass(ClassDefiner.java:45)
        at sun.reflect.MethodAccessorGenerator$1.run(MethodAccessorGenerator.java:381)
        at java.security.AccessController.doPrivileged(Native Method)
        at sun.reflect.MethodAccessorGenerator.generate(MethodAccessorGenerator.java:377)
        at sun.reflect.MethodAccessorGenerator.generateMethod(MethodAccessorGenerator.java:59)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:28)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
        at java.lang.reflect.Method.invoke(Method.java:597)
        at org.jboss.byteman.rule.expression.MethodExpression.interpret(MethodExpression.java:342)
        at org.jboss.byteman.rule.Action.interpret(Action.java:144)
        at org.systemtap.byteman.helper.HelperSDT_HelperAdapter_Interpreted_1.fire(tacy-22167.btm)
        at org.systemtap.byteman.helper.HelperSDT_HelperAdapter_Interpreted_1.execute0(tacy-22167.btm)
        at org.systemtap.byteman.helper.HelperSDT_HelperAdapter_Interpreted_1.execute(tacy-22167.btm)
        at org.jboss.byteman.rule.Rule.execute(Rule.java:684)
        at org.jboss.byteman.rule.Rule.execute(Rule.java:653)
        at java.lang.ClassLoader.loadClass(ClassLoader.java)
        at java.lang.Class.forName0(Native Method)
        at java.lang.Class.forName(Class.java:249)
        at sun.rmi.server.LoaderHandler.loadClass(LoaderHandler.java:152)
        at java.rmi.server.RMIClassLoader$2.loadClass(RMIClassLoader.java:620)
        at java.rmi.server.RMIClassLoader.loadClass(RMIClassLoader.java:247)
        at sun.rmi.server.MarshalInputStream.resolveClass(MarshalInputStream.java:201)
        at java.io.ObjectInputStream.readNonProxyDesc(ObjectInputStream.java:1589)
        at java.io.ObjectInputStream.readClassDesc(ObjectInputStream.java:1494)
        at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1748)
        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1327)
        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:349)
        at sun.rmi.server.UnicastRef.unmarshalValue(UnicastRef.java:306)
        at sun.rmi.server.UnicastRef.invoke(UnicastRef.java:155)
        at com.sun.jmx.remote.internal.PRef.invoke(Unknown Source)
        at javax.management.remote.rmi.RMIConnectionImpl_Stub.getAttribute(Unknown Source)
        at javax.management.remote.rmi.RMIConnector$RemoteMBeanServerConnection.getAttribute(RMIConnector.java:878)

</pre>


<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn-.1" href="#fnr-.1">1</a></sup> <a href="https://wiki.ubuntu.com/DebuggingProgramCrash">Debugging Program Crash</a>
</p>


<p class="footnote"><sup><a class="footnum" name="fn-.2" href="#fnr-.2">2</a></sup> <a href="http://developerblog.redhat.com/2014/01/10/probing-java-w-systemtap/">Probing java methods with systemtap</a>
</p></div>
</div>
</div>
</div>

</div>
</div>
