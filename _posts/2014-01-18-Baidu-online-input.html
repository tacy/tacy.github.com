---
layout: post
title: "百度在线输入法Python代码"
description: "写了一段python代码，用于xbmc，通过云输入方式支持xbmc中文输入"
categories: [tech]
tags: [python, xbmc]
---

<p>
代码里面有一些xbmc的语句，可以忽略，脚本只是提供了一个基本逻辑，供参考。
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #FBDE2D;">def</span> <span style="color: #ff1493;">__init__</span><span style="color: #8b0000;">(</span> <span style="color: #FBDE2D;">self</span>, *args, **kwargs <span style="color: #8b0000;">)</span>:
    <span style="color: #FBDE2D;">self</span>.totalpage = 0
    <span style="color: #FBDE2D;">self</span>.nowpage = 0
    <span style="color: #FBDE2D;">self</span>.words = <span style="color: #61CE3C;">''</span>
    <span style="color: #FBDE2D;">self</span>.py = <span style="color: #61CE3C;">''</span>
    <span style="color: #FBDE2D;">self</span>.bg = 0
    <span style="color: #FBDE2D;">self</span>.ed = 20
    <span style="color: #FBDE2D;">self</span>.wordpgs = <span style="color: #8b0000;">[]</span>   <span style="color: #8B8989; font-style: italic;">#</span><span style="color: #8B8989; font-style: italic;">word page metadata</span>
    <span style="color: #FBDE2D;">self</span>.inputString = kwargs.get<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">"default"</span><span style="color: #8b0000;">)</span> <span style="color: #FBDE2D;">or</span> <span style="color: #61CE3C;">""</span>
    <span style="color: #FBDE2D;">self</span>.heading = kwargs.get<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">"heading"</span><span style="color: #8b0000;">)</span> <span style="color: #FBDE2D;">or</span> <span style="color: #61CE3C;">""</span>
    <span style="color: #FBDE2D;">self</span>.fetchCookie<span style="color: #8b0000;">()</span>
    <span style="color: #FBDE2D;">self</span>.conn = httplib.HTTPConnection<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">'olime.baidu.com'</span><span style="color: #8b0000;">)</span>
    xbmcgui.WindowXMLDialog.__init__<span style="color: #8b0000;">(</span><span style="color: #FBDE2D;">self</span><span style="color: #8b0000;">)</span>

<span style="color: #FBDE2D;">def</span> <span style="color: #ff1493;">fetchCookie</span><span style="color: #8b0000;">(</span><span style="color: #FBDE2D;">self</span><span style="color: #8b0000;">)</span>:
    <span style="color: #D8FA3C;">req</span> = urllib2.Request<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">'http://ime.baidu.com/online.html'</span><span style="color: #8b0000;">)</span>
    req.add_header<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">'User-Agent'</span>, UserAgent<span style="color: #8b0000;">)</span>
    <span style="color: #D8FA3C;">response</span> = urllib2.urlopen<span style="color: #8b0000;">(</span>req<span style="color: #8b0000;">)</span>
    response.close<span style="color: #8b0000;">()</span>
    <span style="color: #D8FA3C;">cdata</span> = response.info<span style="color: #8b0000;">()</span>.get<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">'Set-Cookie'</span><span style="color: #8b0000;">)</span>
    <span style="color: #FBDE2D;">self</span>.cookie = cdata.split<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">';'</span><span style="color: #8b0000;">)[</span>0<span style="color: #8b0000;">]</span>
    <span style="color: #FBDE2D;">if</span> re.search<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">'BAIDUID'</span>,<span style="color: #FBDE2D;">self</span>.cookie<span style="color: #8b0000;">)</span> <span style="color: #FBDE2D;">is</span> <span style="color: #4c83ff;">None</span>: <span style="color: #8B8989; font-style: italic;"># </span><span style="color: #8B8989; font-style: italic;">just in case</span>
        <span style="color: #FBDE2D;">self</span>.cookie=<span style="color: #61CE3C;">'BAIDUID=5FF5CF0348C2CD89C15799855BBCB09A:FG=1'</span>

<span style="color: #FBDE2D;">def</span> <span style="color: #ff1493;">changepages</span> <span style="color: #8b0000;">(</span><span style="color: #FBDE2D;">self</span><span style="color: #8b0000;">)</span>:
    <span style="color: #FBDE2D;">self</span>.getControl<span style="color: #8b0000;">(</span>CTRL_ID_HZLIST<span style="color: #8b0000;">)</span>.setLabel<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">''</span><span style="color: #8b0000;">)</span>
    <span style="color: #D8FA3C;">hzlist</span> = <span style="color: #61CE3C;">''</span>
    <span style="color: #FBDE2D;">if</span> <span style="color: #FBDE2D;">not</span> <span style="color: #FBDE2D;">self</span>.wordpgs: <span style="color: #FBDE2D;">return</span>
    <span style="color: #FBDE2D;">if</span> <span style="color: #FBDE2D;">self</span>.nowpage &gt;= <span style="color: #FBDE2D;">self</span>.totalpage-1:
        <span style="color: #FBDE2D;">self</span>.bg += 20
        <span style="color: #FBDE2D;">self</span>.ed += 20
        <span style="color: #FBDE2D;">self</span>.getChineseWord<span style="color: #8b0000;">(</span><span style="color: #FBDE2D;">self</span>.py, <span style="color: #FBDE2D;">self</span>.bg, <span style="color: #FBDE2D;">self</span>.ed<span style="color: #8b0000;">)</span>
        <span style="color: #FBDE2D;">return</span>
    <span style="color: #D8FA3C;">curwpg</span> = <span style="color: #FBDE2D;">self</span>.wordpgs<span style="color: #8b0000;">[</span><span style="color: #FBDE2D;">self</span>.nowpage<span style="color: #8b0000;">]</span>
    <span style="color: #FBDE2D;">for</span> i, w <span style="color: #FBDE2D;">in</span> <span style="color: #FF6400;">enumerate</span><span style="color: #8b0000;">(</span><span style="color: #FBDE2D;">self</span>.words<span style="color: #006400;">[</span>curwpg<span style="color: #ff1493;">[</span>0<span style="color: #ff1493;">]</span>:curwpg<span style="color: #ff1493;">[</span>1<span style="color: #ff1493;">]</span><span style="color: #006400;">]</span><span style="color: #8b0000;">)</span>:
        <span style="color: #D8FA3C;">hzlist</span> = hzlist + <span style="color: #FF6400;">str</span><span style="color: #8b0000;">(</span>i<span style="color: #8b0000;">)</span> + <span style="color: #61CE3C;">'.'</span> + w +<span style="color: #61CE3C;">' '</span>
    <span style="color: #FBDE2D;">if</span> <span style="color: #FBDE2D;">self</span>.nowpage &gt; 0:
        <span style="color: #D8FA3C;">hzlist</span> = <span style="color: #61CE3C;">'&lt;'</span> + hzlist
    <span style="color: #FBDE2D;">if</span> <span style="color: #FBDE2D;">self</span>.nowpage &lt; <span style="color: #FBDE2D;">self</span>.totalpage-1:
        <span style="color: #D8FA3C;">hzlist</span> = hzlist + <span style="color: #61CE3C;">'&gt;'</span>
    <span style="color: #FBDE2D;">self</span>.getControl<span style="color: #8b0000;">(</span>CTRL_ID_HZLIST<span style="color: #8b0000;">)</span>.setLabel<span style="color: #8b0000;">(</span>hzlist<span style="color: #8b0000;">)</span>

<span style="color: #FBDE2D;">def</span> <span style="color: #ff1493;">getChineseWord</span> <span style="color: #8b0000;">(</span><span style="color: #FBDE2D;">self</span>, py, bg=0, ed=20<span style="color: #8b0000;">)</span>:
    <span style="color: #FBDE2D;">self</span>.getControl<span style="color: #8b0000;">(</span>CTRL_ID_HZLIST<span style="color: #8b0000;">)</span>.setLabel<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">''</span><span style="color: #8b0000;">)</span>
    <span style="color: #FBDE2D;">if</span> py==<span style="color: #61CE3C;">''</span>: <span style="color: #FBDE2D;">return</span>
    <span style="color: #FBDE2D;">if</span> <span style="color: #FBDE2D;">not</span> bg:
        <span style="color: #FBDE2D;">self</span>.nowpage = 0
        <span style="color: #FBDE2D;">self</span>.totalpage = 0
        <span style="color: #FBDE2D;">self</span>.wordpgs = <span style="color: #8b0000;">[]</span>
        <span style="color: #FBDE2D;">self</span>.words= <span style="color: #8b0000;">[]</span>
        <span style="color: #FBDE2D;">self</span>.py = py
        <span style="color: #FBDE2D;">self</span>.bg = 0
        <span style="color: #FBDE2D;">self</span>.ed = 20
    <span style="color: #D8FA3C;">wres</span> = <span style="color: #FBDE2D;">self</span>.getwords<span style="color: #8b0000;">(</span>py, bg, ed<span style="color: #8b0000;">)</span>
    <span style="color: #FBDE2D;">if</span> wres:
        <span style="color: #FBDE2D;">self</span>.words.extend<span style="color: #8b0000;">(</span>wres<span style="color: #8b0000;">)</span>
        <span style="color: #FBDE2D;">self</span>.wordpgs = <span style="color: #8b0000;">[]</span>
        <span style="color: #D8FA3C;">inum</span> = 0
        <span style="color: #FBDE2D;">for</span> s, w <span style="color: #FBDE2D;">in</span> <span style="color: #FF6400;">enumerate</span><span style="color: #8b0000;">(</span><span style="color: #FBDE2D;">self</span>.words<span style="color: #8b0000;">)</span>:
            <span style="color: #FBDE2D;">if</span> <span style="color: #FF6400;">len</span><span style="color: #8b0000;">(</span><span style="color: #61CE3C;">''</span>.join<span style="color: #006400;">(</span><span style="color: #FBDE2D;">self</span>.words<span style="color: #ff1493;">[</span>inum:s+1<span style="color: #ff1493;">]</span><span style="color: #006400;">)</span>.decode<span style="color: #006400;">(</span><span style="color: #61CE3C;">'utf-8'</span><span style="color: #006400;">)</span><span style="color: #8b0000;">)</span> + <span style="color: #8b0000;">(</span>
                    s+1-inum<span style="color: #8b0000;">)</span>*2 &gt;30:
                <span style="color: #FBDE2D;">self</span>.wordpgs.append<span style="color: #8b0000;">(</span><span style="color: #006400;">(</span>inum, s<span style="color: #006400;">)</span><span style="color: #8b0000;">)</span>
                <span style="color: #D8FA3C;">inum</span> = s
        <span style="color: #FBDE2D;">if</span> <span style="color: #FF6400;">len</span><span style="color: #8b0000;">(</span><span style="color: #FBDE2D;">self</span>.words<span style="color: #8b0000;">)</span> &gt; inum:
            <span style="color: #FBDE2D;">self</span>.wordpgs.append<span style="color: #8b0000;">(</span><span style="color: #006400;">(</span>inum, <span style="color: #FF6400;">len</span><span style="color: #ff1493;">(</span><span style="color: #FBDE2D;">self</span>.words<span style="color: #ff1493;">)</span><span style="color: #006400;">)</span><span style="color: #8b0000;">)</span>
        <span style="color: #FBDE2D;">self</span>.totalpage = <span style="color: #FF6400;">len</span><span style="color: #8b0000;">(</span><span style="color: #FBDE2D;">self</span>.wordpgs<span style="color: #8b0000;">)</span>
    <span style="color: #FBDE2D;">else</span>:
        <span style="color: #FBDE2D;">self</span>.nowpage = <span style="color: #FBDE2D;">self</span>.totalpage - 1

    <span style="color: #D8FA3C;">hzlist</span> = <span style="color: #61CE3C;">''</span>
    <span style="color: #D8FA3C;">curwpg</span> = <span style="color: #FBDE2D;">self</span>.wordpgs<span style="color: #8b0000;">[</span><span style="color: #FBDE2D;">self</span>.nowpage<span style="color: #8b0000;">]</span>
    <span style="color: #FBDE2D;">for</span> i, w <span style="color: #FBDE2D;">in</span> <span style="color: #FF6400;">enumerate</span><span style="color: #8b0000;">(</span><span style="color: #FBDE2D;">self</span>.words<span style="color: #006400;">[</span>curwpg<span style="color: #ff1493;">[</span>0<span style="color: #ff1493;">]</span>:curwpg<span style="color: #ff1493;">[</span>1<span style="color: #ff1493;">]</span><span style="color: #006400;">]</span><span style="color: #8b0000;">)</span>:
        <span style="color: #D8FA3C;">hzlist</span> = hzlist + <span style="color: #FF6400;">str</span><span style="color: #8b0000;">(</span>i<span style="color: #8b0000;">)</span> + <span style="color: #61CE3C;">'.'</span> + w +<span style="color: #61CE3C;">' '</span>
    <span style="color: #FBDE2D;">if</span> <span style="color: #FBDE2D;">self</span>.nowpage &gt; 0:
        <span style="color: #D8FA3C;">hzlist</span> = <span style="color: #61CE3C;">'&lt;'</span> + hzlist
    <span style="color: #FBDE2D;">if</span> <span style="color: #FBDE2D;">self</span>.nowpage &lt; <span style="color: #FBDE2D;">self</span>.totalpage-1:
        <span style="color: #D8FA3C;">hzlist</span> = hzlist + <span style="color: #61CE3C;">'&gt;'</span>
    <span style="color: #FBDE2D;">self</span>.getControl<span style="color: #8b0000;">(</span>CTRL_ID_HZLIST<span style="color: #8b0000;">)</span>.setLabel<span style="color: #8b0000;">(</span>hzlist<span style="color: #8b0000;">)</span>

<span style="color: #FBDE2D;">def</span> <span style="color: #ff1493;">getwords</span><span style="color: #8b0000;">(</span><span style="color: #FBDE2D;">self</span>, py, bg, ed<span style="color: #8b0000;">)</span>:
    <span style="color: #D8FA3C;">t</span> = time.time<span style="color: #8b0000;">()</span>
    <span style="color: #D8FA3C;">urlsuf</span> = <span style="color: #61CE3C;">'/py?input={0}&amp;inputtype=py&amp;bg={1}&amp;ed={2}&amp;{3}'</span>.<span style="color: #FF6400;">format</span><span style="color: #8b0000;">(</span>
        py, bg, ed,
        <span style="color: #61CE3C;">'result=hanzi&amp;resultcoding=unicode&amp;ch_en=0&amp;clientinfo=web'</span><span style="color: #8b0000;">)</span>
    <span style="color: #FBDE2D;">try</span>:
        <span style="color: #FBDE2D;">self</span>.conn.request<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">'GET'</span>, urlsuf, headers=<span style="color: #006400;">{</span><span style="color: #61CE3C;">'Cookies'</span>:<span style="color: #FBDE2D;">self</span>.cookie,<span style="color: #006400;">}</span><span style="color: #8b0000;">)</span>
    <span style="color: #FBDE2D;">except</span> <span style="color: #D8FA3C;">Exception</span> <span style="color: #FBDE2D;">as</span> e:
        <span style="color: #FBDE2D;">self</span>.conn = httplib.HTTPConnection<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">'olime.baidu.com'</span><span style="color: #8b0000;">)</span>
        <span style="color: #FBDE2D;">self</span>.conn.request<span style="color: #8b0000;">(</span><span style="color: #61CE3C;">'GET'</span>, urlsuf, headers=<span style="color: #006400;">{</span><span style="color: #61CE3C;">'Cookies'</span>:<span style="color: #FBDE2D;">self</span>.cookie,<span style="color: #006400;">}</span><span style="color: #8b0000;">)</span>
    <span style="color: #D8FA3C;">httpdata</span> = <span style="color: #FBDE2D;">self</span>.conn.getresponse<span style="color: #8b0000;">()</span>.read<span style="color: #8b0000;">()</span>
    <span style="color: #D8FA3C;">words</span> = <span style="color: #8b0000;">[]</span>
    <span style="color: #FBDE2D;">try</span>:
        <span style="color: #D8FA3C;">jsondata</span> = simplejson.loads<span style="color: #8b0000;">(</span>httpdata<span style="color: #8b0000;">)</span>
    <span style="color: #FBDE2D;">except</span> <span style="color: #D8FA3C;">ValueError</span>:
        <span style="color: #FBDE2D;">return</span> <span style="color: #4c83ff;">None</span>
    <span style="color: #FBDE2D;">for</span> word <span style="color: #FBDE2D;">in</span> jsondata<span style="color: #8b0000;">[</span>0<span style="color: #8b0000;">]</span>:
        words.append<span style="color: #8b0000;">(</span>word<span style="color: #006400;">[</span>0<span style="color: #006400;">]</span>.encode<span style="color: #006400;">(</span><span style="color: #61CE3C;">'utf-8'</span><span style="color: #006400;">)</span><span style="color: #8b0000;">)</span>
    <span style="color: #FBDE2D;">return</span> words
</pre>
</div>
